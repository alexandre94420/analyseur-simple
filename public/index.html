<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analyseur de Performance Web</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --green: #4CAF50;
      --orange: #FF9800;
      --red: #F44336;
      --gray: #9E9E9E;
    }
    body { 
      font-family: Arial, sans-serif; 
      max-width: 1000px; 
      margin: 2rem auto; 
      padding: 0 1rem; 
      line-height: 1.6;
    }
    input, button { 
      padding: 0.7rem; 
      font-size: 1rem; 
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    input { 
      width: 60%; 
      margin-right: 1%; 
    }
    button { 
      width: 15%; 
      cursor: pointer;
    }
    #analyzeBtn {
      background: #2196F3;
      color: white;
      border: none;
    }
    #exportBtn { 
      width: auto; 
      background: #4CAF50; 
      color: white; 
      border: none; 
      padding: 0.7rem 1.5rem;
    }
    .green { color: var(--green); }
    .orange { color: var(--orange); }
    .red { color: var(--red); }
    .gray { color: var(--gray); }
    .result { margin-top: 2rem; }
    .tab-container { margin-top: 1rem; }
    .tab-buttons { 
      display: flex; 
      margin-bottom: 1rem;
      gap: 5px;
    }
    .tab-btn { 
      padding: 10px 20px; 
      background: #f1f1f1; 
      border: none; 
      cursor: pointer;
      border-radius: 4px 4px 0 0;
      transition: all 0.3s;
    }
    .tab-btn:hover { background: #e0e0e0; }
    .tab-btn.active { 
      background: #2196F3; 
      color: white; 
      font-weight: bold; 
    }
    .tab-content { 
      display: none; 
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 0 0 4px 4px;
    }
    .tab-content.active { display: block; }
    .scores-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
    .score-card { 
      padding: 1.5rem; 
      background: #f9f9f9; 
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .score-value { 
      font-size: 2.5rem; 
      font-weight: bold; 
      margin: 0.5rem 0; 
    }
    .audits-container {
      margin-top: 2rem;
    }
    .audit-item { 
      margin-bottom: 1.5rem; 
      padding: 1.5rem; 
      background: white; 
      border-left: 6px solid;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .audit-item.green { border-left-color: var(--green); }
    .audit-item.orange { border-left-color: var(--orange); }
    .audit-item.red { border-left-color: var(--red); }
    .audit-item.gray { border-left-color: var(--gray); }
    .audit-title { 
      font-weight: bold; 
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    .audit-desc { 
      color: #555; 
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }
    .audit-value { 
      margin-top: 0.5rem; 
      font-style: italic;
      color: #333;
    }
    .audit-score {
      margin-top: 0.5rem;
      font-weight: bold;
    }
    .audit-details {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: #f5f5f5;
      border-radius: 4px;
      font-size: 0.85rem;
    }
    .detail-item {
      margin: 0.3rem 0;
      padding-left: 1rem;
      border-left: 3px solid #ddd;
    }
    @media (max-width: 768px) {
      input { width: 100%; margin-right: 0; margin-bottom: 0.5rem; }
      button { width: 100%; }
      .tab-buttons { flex-direction: column; }
      .scores-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <h1>Analyseur de Performance Web</h1>

  <div style="display: flex; gap: 10px; flex-wrap: wrap;">
    <input id="urlInput" type="text" placeholder="https://exemple.com" />
    <button id="analyzeBtn">Analyser</button>
    <button id="exportBtn" style="display:none;">Générer PDF</button>
  </div>

  <div id="result" class="result"></div>

  <script>
    // Configuration des audits
    const AUDITS_PERTINENTS = {
      performance: [
        "first-contentful-paint",
        "speed-index",
        "largest-contentful-paint",
        "interactive",
        "total-blocking-time",
        "cumulative-layout-shift"
      ],
      accessibility: [
        "aria-valid-attr",
        "aria-allowed-attr",
        "color-contrast",
        "image-alt",
        "label"
      ],
      "best-practices": [
        "doctype",
        "js-libraries",
        "errors-in-console",
        "no-vulnerable-libraries",
        "notification-on-start"
      ],
      seo: [
        "viewport",
        "document-title",
        "meta-description",
        "http-status-code",
        "link-text",
        "crawlable-anchors"
      ]
    };

    const TITRES_FR = {
      // Performance
      "first-contentful-paint": "Premier contenu visible",
      "speed-index": "Indice de vitesse",
      "largest-contentful-paint": "Plus grand contenu visible",
      "interactive": "Disponibilité interactive",
      "total-blocking-time": "Temps de blocage total",
      "cumulative-layout-shift": "Décalages visuels cumulés",
      
      // Accessibilité
      "aria-valid-attr": "Attributs ARIA valides",
      "aria-allowed-attr": "Attributs ARIA autorisés",
      "color-contrast": "Contraste des couleurs",
      "image-alt": "Texte alternatif des images",
      "label": "Étiquettes des champs",
      
      // Bonnes pratiques
      "doctype": "Doctype HTML",
      "js-libraries": "Bibliothèques JavaScript",
      "errors-in-console": "Erreurs dans la console",
      "no-vulnerable-libraries": "Bibliothèques sécurisées",
      "notification-on-start": "Notifications au démarrage",
      
      // SEO
      "viewport": "Viewport mobile",
      "document-title": "Titre de page",
      "meta-description": "Méta description",
      "http-status-code": "Code HTTP valide",
      "link-text": "Texte des liens",
      "crawlable-anchors": "Liens explorables"
    };

    const DESCRIPTIONS_FR = {
      // Performance
      "first-contentful-paint": "Temps avant l'affichage du premier élément de contenu. Cible : < 2s.",
      "speed-index": "Mesure la rapidité perçue du chargement. Plus le score est élevé, mieux c'est.",
      "largest-contentful-paint": "Temps avant l'affichage du plus grand élément visible. Cible : < 2.5s.",
      "interactive": "Temps avant que la page soit complètement interactive. Cible : < 3.5s.",
      "total-blocking-time": "Temps pendant lequel la page est bloquée et ne répond pas. Cible : < 200ms.",
      "cumulative-layout-shift": "Mesure les mouvements inattendus des éléments pendant le chargement.",
      
      // Accessibilité
      "aria-valid-attr": "Les attributs ARIA doivent avoir des valeurs valides.",
      "aria-allowed-attr": "Seuls les attributs ARIA autorisés doivent être utilisés.",
      "color-contrast": "Le contraste texte/arrière-plan doit être suffisant (ratio minimum 4.5:1).",
      "image-alt": "Les images doivent avoir un texte alternatif pour les lecteurs d'écran.",
      "label": "Tous les champs de formulaire doivent avoir des étiquettes claires.",
      
      // Bonnes pratiques
      "doctype": "Le document doit déclarer un doctype valide.",
      "js-libraries": "Détecte les bibliothèques JavaScript utilisées.",
      "errors-in-console": "Aucune erreur ne devrait apparaître dans la console.",
      "no-vulnerable-libraries": "Vérifie que les bibliothèques utilisées ne contiennent pas de failles de sécurité connues.",
      "notification-on-start": "Les notifications ne devraient pas être demandées au chargement de la page.",
      
      // SEO
      "viewport": "La balise viewport est essentielle pour le responsive design.",
      "document-title": "Le titre de la page doit être unique et descriptif.",
      "meta-description": "La méta description améliore l'affichage dans les moteurs de recherche.",
      "http-status-code": "Le code HTTP doit être 200 (OK) pour la page principale.",
      "link-text": "Les liens doivent avoir un texte descriptif pour l'accessibilité et le SEO.",
      "crawlable-anchors": "Les liens doivent être explorables par les moteurs de recherche."
    };

    const CATEGORIES_FR = {
      performance: "Performance",
      accessibility: "Accessibilité",
      "best-practices": "Bonnes pratiques",
      seo: "SEO"
    };

    // Variables globales pour stocker les données
    let currentAnalysisData = null;

    // Éléments DOM
    const analyzeBtn = document.getElementById("analyzeBtn");
    const urlInput = document.getElementById("urlInput");
    const exportBtn = document.getElementById("exportBtn");
    const resultDiv = document.getElementById("result");

    // Fonctions utilitaires
    function getScoreColor(score) {
      if (score === null || score === undefined) return "gray";
      if (score >= 0.9) return "green";
      if (score >= 0.5) return "orange";
      return "red";
    }

    function formatScore(score) {
      return (score === null || score === undefined) ? "N/A" : (score * 100).toFixed(0) + '%';
    }

    function formatDetails(items) {
      if (!items || !items.length) return '';
      
      return `
        <div class="audit-details">
          ${items.map(item => `
            <div class="detail-item">
              ${item.node ? `<strong>Élément:</strong> ${item.node.selector || item.node.nodeLabel || ''}<br>` : ''}
              ${item.reason ? `<strong>Raison:</strong> ${item.reason}<br>` : ''}
              ${item.url ? `<strong>URL:</strong> ${item.url}` : ''}
            </div>
          `).join('')}
        </div>
      `;
    }

    function createTabContent(data, strategy) {
      const lighthouse = data.lighthouseResult;
      const audits = lighthouse.audits;
      const categories = lighthouse.categories;

      let html = `
        <div class="scores-container">
          <h2>Scores globaux (${strategy === 'desktop' ? 'Bureau' : 'Mobile'})</h2>
          <div class="scores-grid">`;

      // Affiche les scores pour les 4 catégories principales
      const mainCategories = ['performance', 'accessibility', 'best-practices', 'seo'];
      mainCategories.forEach(catId => {
        const category = categories[catId];
        if (!category) return;
        
        const score = category.score;
        const colorClass = getScoreColor(score);
        html += `
          <div class="score-card">
            <div>${CATEGORIES_FR[catId] || category.title}</div>
            <div class="score-value ${colorClass}">${formatScore(score)}</div>
          </div>`;
      });

      html += `</div></div><div class="audits-container"><h2>Détails par catégorie</h2>`;

      // Affiche les audits pour chaque catégorie
      mainCategories.forEach(catId => {
        const category = categories[catId];
        if (!category) return;

        html += `<h3>${CATEGORIES_FR[catId] || category.title}</h3>`;
        
        AUDITS_PERTINENTS[catId].forEach(auditId => {
          const audit = audits[auditId];
          if (!audit) return;

          const colorClass = getScoreColor(audit.score);
          const title = TITRES_FR[auditId] || audit.title;
          const description = DESCRIPTIONS_FR[auditId] || audit.description;
          
          html += `
            <div class="audit-item ${colorClass}">
              <div class="audit-title">${title}</div>
              <div class="audit-desc">${description}</div>
              ${audit.displayValue ? `<div class="audit-value">${audit.displayValue}</div>` : ''}
              <div class="audit-score ${colorClass}">Score: ${formatScore(audit.score)}</div>
              ${audit.details ? formatDetails(audit.details.items) : ''}
            </div>`;
        });
      });

      html += `</div>`;
      return html;
    }

    // Gestion de l'analyse
    analyzeBtn.addEventListener("click", async () => {
      const url = urlInput.value.trim();
      if (!url) {
        alert("Veuillez entrer une URL valide");
        return;
      }

      resultDiv.innerHTML = "<p>Analyse en cours... Cette opération peut prendre quelques secondes.</p>";
      exportBtn.style.display = "none";

      try {
        // Simulation d'une analyse (remplacez par votre vraie API)
        const mockData = {
          desktop: {
            lighthouseResult: {
              categories: {
                performance: { score: 0.85, title: "Performance" },
                accessibility: { score: 0.92, title: "Accessibilité" },
                "best-practices": { score: 0.88, title: "Bonnes pratiques" },
                seo: { score: 0.95, title: "SEO" }
              },
              audits: {
                "first-contentful-paint": { score: 0.9, title: "Premier contenu visible", displayValue: "1.2s", description: "Test description" },
                "speed-index": { score: 0.8, title: "Indice de vitesse", displayValue: "2.1s", description: "Test description" },
                "largest-contentful-paint": { score: 0.85, title: "Plus grand contenu visible", displayValue: "2.3s", description: "Test description" },
                "interactive": { score: 0.75, title: "Disponibilité interactive", displayValue: "3.1s", description: "Test description" },
                "total-blocking-time": { score: 0.9, title: "Temps de blocage total", displayValue: "150ms", description: "Test description" },
                "cumulative-layout-shift": { score: 0.95, title: "Décalages visuels cumulés", displayValue: "0.05", description: "Test description" },
                "aria-valid-attr": { score: 1, title: "Attributs ARIA valides", description: "Test description" },
                "aria-allowed-attr": { score: 1, title: "Attributs ARIA autorisés", description: "Test description" },
                "color-contrast": { score: 0.8, title: "Contraste des couleurs", description: "Test description" },
                "image-alt": { score: 0.9, title: "Texte alternatif des images", description: "Test description" },
                "label": { score: 1, title: "Étiquettes des champs", description: "Test description" },
                "doctype": { score: 1, title: "Doctype HTML", description: "Test description" },
                "js-libraries": { score: 0.9, title: "Bibliothèques JavaScript", description: "Test description" },
                "errors-in-console": { score: 0.8, title: "Erreurs dans la console", description: "Test description" },
                "no-vulnerable-libraries": { score: 1, title: "Bibliothèques sécurisées", description: "Test description" },
                "notification-on-start": { score: 1, title: "Notifications au démarrage", description: "Test description" },
                "viewport": { score: 1, title: "Viewport mobile", description: "Test description" },
                "document-title": { score: 1, title: "Titre de page", description: "Test description" },
                "meta-description": { score: 1, title: "Méta description", description: "Test description" },
                "http-status-code": { score: 1, title: "Code HTTP valide", description: "Test description" },
                "link-text": { score: 0.9, title: "Texte des liens", description: "Test description" },
                "crawlable-anchors": { score: 1, title: "Liens explorables", description: "Test description" }
              }
            }
          },
          mobile: {
            lighthouseResult: {
              categories: {
                performance: { score: 0.65, title: "Performance" },
                accessibility: { score: 0.92, title: "Accessibilité" },
                "best-practices": { score: 0.88, title: "Bonnes pratiques" },
                seo: { score: 0.95, title: "SEO" }
              },
              audits: {
                "first-contentful-paint": { score: 0.7, title: "Premier contenu visible", displayValue: "1.8s", description: "Test description" },
                "speed-index": { score: 0.6, title: "Indice de vitesse", displayValue: "3.2s", description: "Test description" },
                "largest-contentful-paint": { score: 0.65, title: "Plus grand contenu visible", displayValue: "3.1s", description: "Test description" },
                "interactive": { score: 0.55, title: "Disponibilité interactive", displayValue: "4.2s", description: "Test description" },
                "total-blocking-time": { score: 0.7, title: "Temps de blocage total", displayValue: "280ms", description: "Test description" },
                "cumulative-layout-shift": { score: 0.9, title: "Décalages visuels cumulés", displayValue: "0.08", description: "Test description" },
                "aria-valid-attr": { score: 1, title: "Attributs ARIA valides", description: "Test description" },
                "aria-allowed-attr": { score: 1, title: "Attributs ARIA autorisés", description: "Test description" },
                "color-contrast": { score: 0.8, title: "Contraste des couleurs", description: "Test description" },
                "image-alt": { score: 0.9, title: "Texte alternatif des images", description: "Test description" },
                "label": { score: 1, title: "Étiquettes des champs", description: "Test description" },
                "doctype": { score: 1, title: "Doctype HTML", description: "Test description" },
                "js-libraries": { score: 0.9, title: "Bibliothèques JavaScript", description: "Test description" },
                "errors-in-console": { score: 0.8, title: "Erreurs dans la console", description: "Test description" },
                "no-vulnerable-libraries": { score: 1, title: "Bibliothèques sécurisées", description: "Test description" },
                "notification-on-start": { score: 1, title: "Notifications au démarrage", description: "Test description" },
                "viewport": { score: 1, title: "Viewport mobile", description: "Test description" },
                "document-title": { score: 1, title: "Titre de page", description: "Test description" },
                "meta-description": { score: 1, title: "Méta description", description: "Test description" },
                "http-status-code": { score: 1, title: "Code HTTP valide", description: "Test description" },
                "link-text": { score: 0.9, title: "Texte des liens", description: "Test description" },
                "crawlable-anchors": { score: 1, title: "Liens explorables", description: "Test description" }
              }
            }
          }
        };

        currentAnalysisData = { data: mockData, url: url };

        // Crée l'interface à onglets
        resultDiv.innerHTML = `
          <div class="tab-container">
            <div class="tab-buttons">
              <button class="tab-btn active" data-tab="desktop">Version Bureau</button>
              <button class="tab-btn" data-tab="mobile">Version Mobile</button>
            </div>
            <div id="desktopTab" class="tab-content active"></div>
            <div id="mobileTab" class="tab-content"></div>
          </div>
        `;

        // Remplit les onglets
        document.getElementById('desktopTab').innerHTML = createTabContent(mockData.desktop, 'desktop');
        document.getElementById('mobileTab').innerHTML = createTabContent(mockData.mobile, 'mobile');
        exportBtn.style.display = "inline-block";

        // Gestion des onglets
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            this.classList.add('active');
            document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
          });
        });

      } catch (err) {
        console.error("Erreur lors de l'analyse:", err);
        resultDiv.innerHTML = `<p class="red">Erreur lors de l'analyse: ${err.message}</p>`;
      }
    });

    // Fonction simplifiée pour générer le PDF
    exportBtn.addEventListener('click', () => {
      if (!currentAnalysisData) {
        alert("Aucune analyse à exporter. Veuillez d'abord effectuer une analyse.");
        return;
      }

      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
        const strategy = activeTab === 'desktop' ? 'Bureau' : 'Mobile';
        const data = currentAnalysisData.data[activeTab];
        const url = currentAnalysisData.url;
        
        let yPosition = 20;
        const pageWidth = 190;
        
        // En-tête
        doc.setFontSize(18);
        doc.setTextColor(33, 150, 243);
        doc.text(`Rapport Lighthouse - ${strategy}`, 105, yPosition, { align: 'center' });
        
        yPosition += 15;
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text(`URL: ${url}`, 20, yPosition);
        yPosition += 5;
        doc.text(`Date: ${new Date().toLocaleString('fr-FR')}`, 20, yPosition);
        yPosition += 10;
        
        // Ligne de séparation
        doc.line(20, yPosition, 190, yPosition);
        yPosition += 15;
        
        // Scores globaux
        doc.setFontSize(16);
        doc.setTextColor(0, 0, 0);
        doc.text('Scores globaux', 20, yPosition);
        yPosition += 10;
        
        const categories = data.lighthouseResult.categories;
        const mainCategories = ['performance', 'accessibility', 'best-practices', 'seo'];
        
        mainCategories.forEach(catId => {
          const category = categories[catId];
          if (category) {
            const score = formatScore(category.score);
            const color = getScoreColor(category.score);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`${CATEGORIES_FR[catId]}:`, 20, yPosition);
            
            // Couleur du score
            if (color === 'green') doc.setTextColor(76, 175, 80);
            else if (color === 'orange') doc.setTextColor(255, 152, 0);
            else if (color === 'red') doc.setTextColor(244, 67, 54);
            else doc.setTextColor(100, 100, 100);
            
            doc.text(score, 80, yPosition);
            yPosition += 8;
          }
        });
        
        yPosition += 10;
        
        // Détails par catégorie
        doc.setFontSize(16);
        doc.setTextColor(0, 0, 0);
        doc.text('Détails par catégorie', 20, yPosition);
        yPosition += 10;
        
        const audits = data.lighthouseResult.audits;
        
        mainCategories.forEach(catId => {
          // Vérifier si on a besoin d'une nouvelle page
          if (yPosition > 250) {
            doc.addPage();
            yPosition = 20;
          }
          
          doc.setFontSize(14);
          doc.setTextColor(0, 0, 0);
          doc.text(CATEGORIES_FR[catId], 20, yPosition);
          yPosition += 8;
          
          AUDITS_PERTINENTS[catId].forEach(auditId => {
            const audit = audits[auditId];
            if (audit) {
              // Vérifier si on a besoin d'une nouvelle page
              if (yPosition > 270) {
                doc.addPage();
                yPosition = 20;
              }
              
              const title = TITRES_FR[auditId] || audit.title;
              const score = formatScore(audit.score);
              const color = getScoreColor(audit.score);
              
              doc.setFontSize(11);
              doc.setTextColor(0, 0, 0);
              doc.text(title, 25, yPosition);
              
              // Couleur du score
              if (color === 'green') doc.setTextColor(76, 175, 80);
              else if (color === 'orange') doc.setTextColor(255, 152, 0);
              else if (color === 'red') doc.setTextColor(244, 67, 54);
              else doc.setTextColor(100, 100, 100);
              
              doc.text(score, 150, yPosition);
              yPosition += 5;
              
              if (audit.displayValue) {
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.text(audit.displayValue, 25, yPosition);
                yPosition += 5;
              }
              
              yPosition += 3;
            }
          });
          
          yPosition += 5;
        });
        
        // Nom du fichier
        const domain = url.replace(/^https?:\/\//, '').split('/')[0];
        const fileName = `Lighthouse-${domain}-${strategy}-${new Date().toISOString().slice(0,10)}.pdf`;
        
        // Télécharger le PDF
        doc.save(fileName);
        
      } catch (error) {
        console.error('Erreur lors de la génération du PDF:', error);
        alert('Erreur lors de la génération du PDF. Veuillez réessayer.');
      }
    });

    // Permet d'analyser avec la touche Entrée
    urlInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') analyzeBtn.click();
    });
  </script>
</body>
</html>